@page
@model ForgotPasswordCodeModel
@{
    ViewData["Title"] = "Подтверждение сброса пароля";
}

<h1>@ViewData["Title"]</h1>
<h2>Введите код, отправленный на почту.</h2>
<hr />
<div class="row">
    <div class="col-md-4">
        <form method="post">
            <div asp-validation-summary="ModelOnly"
                 class="text-danger"
                 role="alert"></div>

            <input asp-for="Input.Email"
                   type="hidden" />

            <div class="form-floating mb-3">
                <input class="form-control"
                       value="@Model.Input.Email"
                       readonly />
                <label class="form-label">Почта</label>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Code"
                       class="form-control"
                       autocomplete="one-time-code"
                       aria-required="true"
                       placeholder="00000000" />
                <label asp-for="Input.Code"
                       class="form-label"></label>
                <span asp-validation-for="Input.Code"
                      class="text-danger"></span>
            </div>

            <button type="submit"
                    class="w-100 btn btn-lg btn-primary">Продолжить
            </button>
        </form>

        <form method="post"
              asp-page-handler="Resend"
              class="mt-3"
              id="resend-container"
              data-remaining="@Math.Ceiling(Model.CooldownRemainingSeconds)">
            <input asp-for="Input.Email"
                   type="hidden" />
            <button type="submit"
                    class="btn btn-link p-0"
                    id="resend-button"
                    disabled="@(Model.CanResend ? null : "disabled")">
                Отправить код повторно
            </button>
            <span id="resend-countdown"
                  class="text-muted ms-2">
                @if (!Model.CanResend)
                {
                    @:$"через {Math.Ceiling(Model.CooldownRemainingSeconds)} сек."
                }
            </span>
        </form>

        @if (!string.IsNullOrEmpty(Model.ResendMessage))
        {
            <div class="alert alert-info mt-2"
                 role="alert">
                @Model.ResendMessage
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const container = document.getElementById('resend-container');
            if (!container) {
                return;
            }

            const button = document.getElementById('resend-button');
            const countdown = document.getElementById('resend-countdown');

            if (!button || !countdown) {
                return;
            }

            let remaining = Number(container.dataset.remaining);

            if (!Number.isFinite(remaining) || remaining <= 0) {
                button.removeAttribute('disabled');
                countdown.textContent = '';
                return;
            }

            const updateCountdown = () => {
                remaining = Math.max(0, remaining - 1);

                if (remaining > 0) {
                    countdown.textContent = `через ${remaining} сек.`;
                } else {
                    countdown.textContent = '';
                    button.removeAttribute('disabled');
                    clearInterval(timerId);
                }
            };

            countdown.textContent = `через ${Math.ceil(remaining)} сек.`;
            const timerId = setInterval(updateCountdown, 1000);
        })();
    </script>
}
